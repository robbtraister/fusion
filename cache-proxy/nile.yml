name: fusion-cache-proxy
type: ecs


_environment: &_environment
  PORT: '8080'

_fusion_cache_proxy: &_fusion_cache_proxy
  image: quay.io/washpost/fusion-cache-proxy:{{.DeploymentId}}
  ports:
    - '8080'
  log_driver: awslogs

_healthcheck: &_healthcheck
  healthcheck:
    interval: 30
    path: '/healthcheck'
    protocol: HTTP
    timeout: 10
    healthy_threshold_count: 2
    unhealthy_threshold_count: 4

_resource: &_resource
  vendor: aws
  resource: simple

_services: &_services
  services:
    - deploymentConfiguration:
        maximumPercent: 200
        minimumHealthyPercent: 50
      desiredCount: 2
      loadBalancers:
        - containerName: fusion-cache-proxy
          containerPort: 8080

_task: &_task
  task:
    taskRoleArn: arn:aws:iam::397853141546:role/fusion-cache-proxy

environments:
  - name: staging
    <<: *_services
    <<: *_task
    namespace: pagebuilder-arc2
    override:
      fusion-cache-proxy:
        <<: *_fusion_cache_proxy
        log_opt:
          awslogs-group: /nile/fusion-cache-proxy/staging
          awslogs-region: us-east-1
        environment:
          CACHE_PROXY_CREDENTIALS: |
            staging:%{AQECAHhPwAyPK3nfERyAvmyWOWx9c41uht+ei4Zlv4NgrlmypwAAAIQwgYEGCSqGSIb3DQEHBqB0MHICAQAwbQYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAzrrX9KLmpVvQCaktcCARCAQJt+/Ucft/DljaEuthLDHCdOv/UeDqPgGSEBnWYnatR53YMfikW5EVwu9rdKP/6AFPPuaZ4By/yeHSTjNrzD4lk=}
          <<: *_environment
    resources:
      - <<: *_resource
        settings:
          <<: *_healthcheck
          scheme: internet-facing
          domain: staging.fusion-cache.arcpublishing.com
          parent_domain: fusion-cache.arcpublishing.com
          subnets:
            - subnet-1a8f9640
            - subnet-9d4bafb2
            - subnet-42943209
