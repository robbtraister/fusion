name: fusion-cache-proxy
type: ecs

_environment: &_environment
  PORT: '8080'

_fusion_cache_proxy: &_fusion_cache_proxy
  image: quay.io/washpost/fusion-cache-proxy:{{.DeploymentId}}
  ports:
    - '8080'
  log_driver: awslogs
  environment:
    <<: *_environment

_healthcheck: &_healthcheck
  healthcheck:
    interval: 30
    path: '/healthcheck'
    protocol: HTTP
    timeout: 10
    healthy_threshold_count: 2
    unhealthy_threshold_count: 4

_resource: &_resource
  vendor: aws
  resource: simple

_services: &_services
  services:
    - deploymentConfiguration:
        maximumPercent: 200
        minimumHealthyPercent: 50
      desiredCount: 3
      loadBalancers:
        - containerName: cache-proxy
          containerPort: 8080

environments:
  - name: staging
    <<: *_services
    namespace: pagebuilder-arc2
    override:
      cache-proxy:
        <<: *_fusion_cache_proxy
        log_opt:
          awslogs-group: /nile/fusion-cache-proxy/staging
          awslogs-region: us-east-1
        environment:
          <<: *_environment
          CACHE_PROXY_CREDENTIALS: |
            staging:%{AQECAHhPwAyPK3nfERyAvmyWOWx9c41uht+ei4Zlv4NgrlmypwAAAMYwgcMGCSqGSIb3DQEHBqCBtTCBsgIBADCBrAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAx004Oqgxt5jnwj1rACARCAf+DSMPzrDHyG/bxRd1T+Jj2MjmcOjNB3gugnPMzgaPGW9TAJ6l3TQkO/Z/MgPugLLWG/p1rI9pSQ3mn8D0r3aIlr4xkzEJEWkX1nq03nDwMlFaBb4ieywpKO2Qq2oaYsIIGsOJaI529Snflz0aR4qZwDOTPlgAI4+gnGkAXAJRU=}
            bonnier:%{AQECAHhPwAyPK3nfERyAvmyWOWx9c41uht+ei4Zlv4NgrlmypwAAAMYwgcMGCSqGSIb3DQEHBqCBtTCBsgIBADCBrAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAztnrEQbPvjv13xXuUCARCAf+Ivm1icL3nw5UL7GrYIzGnoxmwMHdHZFKTSlbnufyg2cVqyePGq+ftXv8tdB8AsydNtqrzraNaCbifhnfs5Fgn+6IRnh9bzejkBVQ60dkn8dCKj6FiCnyCzhQVay2Qn3BH8bEzj70xKO4/eWiUKlq91IPJNalGpzLpKS4vE+Kc=}
            bostonglobe:%{AQECAHhPwAyPK3nfERyAvmyWOWx9c41uht+ei4Zlv4NgrlmypwAAAMYwgcMGCSqGSIb3DQEHBqCBtTCBsgIBADCBrAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAwTWVGDTH6CGq40LV0CARCAf8F2BkWHE1fWUEmvlc/dw0WQsNmtiO5DnzNBIw/FQySaWDiwqwrLcUM3WsEVT+xAxwEpc81q5BgBRmAbaj/cciYssMNG9EXgdDxdoPVufn+ztJMuZjYIAz9+EbQ+8TRDuVFaJsvDNbzxtB0Lf/ZgUG8FaE5Udk68/93rGFd3gdA=}
            leparisien:%{AQECAHhPwAyPK3nfERyAvmyWOWx9c41uht+ei4Zlv4NgrlmypwAAAMYwgcMGCSqGSIb3DQEHBqCBtTCBsgIBADCBrAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAxWR2TVlRhjO6c+/R4CARCAf3SciLFcPc5tLWoYrm/S8lmeJ/U95NsiBnb39dbQ3h9vEsII8ivo2jvGIATTu811MMkPaFZDqdCxsCft7BoCldD92UinfCa9zeevKc+waYGGw0DYud8tICPBGHPXaIqKwsfAKp2TFBa1RSeiGpJxoRrAsD9tRsy+IpczRp0YjMk=}
          CACHE_NODES: |
            fusion-memcached.hrnbpw.0001.use1.cache.amazonaws.com:11211
            fusion-memcached.hrnbpw.0002.use1.cache.amazonaws.com:11211
            fusion-memcached.hrnbpw.0003.use1.cache.amazonaws.com:11211
    resources:
      - <<: *_resource
        settings:
          <<: *_healthcheck
          scheme: internet-facing
          domain: staging.fusion-cache.arcpublishing.com
          parent_domain: fusion-cache.arcpublishing.com
          subnets:
            - subnet-1a8f9640
            - subnet-9d4bafb2
            - subnet-42943209
  - name: eu-central-1
    namespace: fusion-ecs-eu-central-1
    services:
      - deploymentConfiguration:
          maximumPercent: 200
          minimumHealthyPercent: 50
        desiredCount: 3
        loadBalancers:
          - containerName: cache-proxy
            containerPort: 8080
            targetGroupArn: arn:aws:elasticloadbalancing:eu-central-1:057404813832:targetgroup/cache-proxy-eu-central-1/8f1ed2293781d89f
    override:
      cache-proxy:
        <<: *_fusion_cache_proxy
        log_opt:
          awslogs-group: /nile/cache-proxy
          awslogs-region: eu-central-1
        environment:
          <<: *_environment
          CACHE_PROXY_CREDENTIALS: |
            rtl:%{AQICAHiJN/POzfGj5pXOfQn8wNjNFnCWlHPE/i0I4vROnpw0DAHB0+39BqvcYO/jRglue/dFAAAAxjCBwwYJKoZIhvcNAQcGoIG1MIGyAgEAMIGsBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDLZV6JD1AgEwQKVDngIBEIB/0ddJMce97036v8i3AIgZpV/e9gtMHotxabFYfPAjtLdzq8cXAdVqin7EkMEJiWYfUhx49C1/k++NPobdcNi3nns9DQ5XSdugxk/JybPbi5yzlr69idpiyK723dZGXs70AeQHFxIPHED6fRGI+Bhv4L7uRtLvH3c4bGhFWJEYUg==}
          CACHE_NODES: |
            fusion-eu-prod.xl3vuh.0001.euc1.cache.amazonaws.com:11211
            fusion-eu-prod.xl3vuh.0002.euc1.cache.amazonaws.com:11211
            fusion-eu-prod.xl3vuh.0003.euc1.cache.amazonaws.com:11211
  - name: us-east-1
    namespace: fusion-ecs-us-east-1
    services:
      - deploymentConfiguration:
          maximumPercent: 200
          minimumHealthyPercent: 50
        desiredCount: 3
        loadBalancers:
          - containerName: cache-proxy
            containerPort: 8080
            targetGroupArn: arn:aws:elasticloadbalancing:us-east-1:057404813832:targetgroup/cache-proxy-us-east-1/85aa5460886120c7
    override:
      cache-proxy:
        <<: *_fusion_cache_proxy
        log_opt:
          awslogs-group: /nile/cache-proxy
          awslogs-region: us-east-1
        environment:
          <<: *_environment
          CACHE_PROXY_CREDENTIALS: |
            wapo:%{AQICAHgPj5nL72r6uSoUdbqYJLxe7vSJBrtP09dX/FxSUlcWlQGKqLZVsLPYbcT+8qcUTiz8AAAAxjCBwwYJKoZIhvcNAQcGoIG1MIGyAgEAMIGsBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDNW/dQZyg5GMuqXpyQIBEIB/UxH9gy1/IvXS6MnKGGK/23YNPnR8TlHwFDiXydvq2URxmg6k9yIrAXOGu+NJMDtnrBEjeLjIkvHFQokUVcBN/9ZElEWRADjAtJUE4qa4O8/2O9b6dZOI1IFmklb+b5n72/FoXsH2GWNW8btAXJEeYfFZ/O2tQrDByj2MLdHU0A==}
          CACHE_NODES: |
            fusion-us-prod.fpmzzd.0001.use1.cache.amazonaws.com
            fusion-us-prod.fpmzzd.0002.use1.cache.amazonaws.com
            fusion-us-prod.fpmzzd.0003.use1.cache.amazonaws.com