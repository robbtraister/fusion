version: "3"
services:
  assets:
    build:
      context: ./assets
      dockerfile: Dockerfile
    image: fusion/assets
    volumes:
      - "fusion-dist-volume:/assets/dist:rw"
      - "fusion-resources-volume:/assets/resources:rw"
    environment:
      NODE_ENV: production

  proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    image: fusion/proxy
    links:
      - renderer
    ports:
      - "80:8080"
    volumes:
      - "fusion-dist-volume:/proxy/dist:ro"
      - "fusion-resources-volume:/proxy/resources:ro"
    environment:
      PORT: 8080
      TARGET: renderer:8080

  renderer:
    build:
      context: ./renderer
      dockerfile: prod.Dockerfile
    image: fusion/renderer-prod
    volumes:
      - "fusion-dist-volume:/renderer/dist:rw"
    environment:
      PORT: 8080
      NODE_ENV: production

volumes:
  fusion-dist-volume: {}
  fusion-resources-volume: {}
