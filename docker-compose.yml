version: "3"
services:
  assets:
    build:
      context: ./assets
      dockerfile: prod.Dockerfile
    image: fusion/assets-prod
    volumes:
      - "fusion-dist-volume:/workdir/dist:rw"
      - "fusion-resources-volume:/workdir/resources:rw"
    environment:
      NODE_ENV: production

  proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    image: fusion/proxy
    links:
      - renderer
    ports:
      - "80:8080"
    volumes:
      - "fusion-dist-volume:/workdir/dist:ro"
      - "fusion-resources-volume:/workdir/resources:ro"
    environment:
      PORT: 8080
      TARGET: renderer:8080
      TTL: 10m

  renderer:
    build:
      context: ./renderer
      dockerfile: prod.Dockerfile
    depends_on:
      - "assets"
    image: fusion/renderer-prod
    volumes:
      - "fusion-dist-volume:/workdir/dist:rw"
    environment:
      PORT: 8080
      NODE_ENV: production

volumes:
  fusion-dist-volume: {}
  fusion-resources-volume: {}
