# Output Type API

Output Types are used to define the HTML wrapping that is applied to server responses (think `head`, `title`, `meta`, `link`, `script` tags, etc). Anything that is part of the server generated HTML, but is not specific to a page/template should be defined in an output type.

When rendering a page, the `outputType` query parameter will be used to determine which output type is used to handle the request; if no parameter is specified, `default` will be used.

## Implementation

##### Naming

An Output Type is expected to be stored and named in the following format:

- `/src/components/output-types/{outputTypeName}.(js|jsx)`

> This will build an Output Type component where the `{outputTypeName}` portion of the filepath represents the name of the Output Type.

> **NOTE**
>
> Fusion requires that your Output Type contain an element in the body that has an ID value of `fusion-app`, which contains the value `props.children` inside of it. This is the ID that Fusion will render the client side portion of the application into. Without this ID, client-side rendering will fail.

##### Example

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    <html>
      <head>
        <title>{props.metaValue('title') || 'Default Title'}</title>
        <props.MetaTags />
        <props.Libs />
        <props.CssLinks />
        <link rel='icon' type='image/x-icon' href={`${props.contextPath}/resources/img/favicon.ico`} />
      </head>
      <body>
        <h1>Welcome to Fusion!</h1>
        <div id='fusion-app'>
          {props.children}
        </div>
        <props.Fusion />
      </body>
    </html>
  )
}
```

-----

## Props

All props that are made available by the Consumer HOC are also available on Output Types. Consult the [Consumer API docs](./consumer.md#props) for a list of these props.

### `children` - (*Array*)

##### Description

React uses the convention of a prop named `children` to define content that should be inserted inside your component. We respect this convention for output types. In this case, the `children` prop defines the rendered content of the page. If you want to perform client-side-only rendering, do not include this property in your page ([example](../../engine/bundle/components/output-types/spa.jsx)).

##### Example

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    ...
    <div id='fusion-app'>
      {props.children}
    </div>
    ...
  )
}
```

-----

### `deployment()` - (*Function*)

##### Description

The deployment id (of the lambda function) that is generating this response. Should be called as a function receiving the url you want to have modified as `deployment('/pf/resources/styles/main.css')`, but can also be added as a query param to static urls as `?d=${deployment}`. Any urls generated by fusion (e.g., via `CssLinks`) will already be annotated with this param.

Also aliased as `version()`.

##### Parameters

##### Return

##### Example

<!-- TODO: example -->

-----

### `metaValue()` - (*Function*)

##### Description

Similar to `metaTag` above, but returns only the value, not a fully rendered HTML meta tag.

##### Parameters

`metaValue(name, [defaultValue])`

##### Return

<!-- TODO: return value -->

##### Example

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    ...
    <title>{props.metaValue('title') || 'Default Title'}</title>
    ...
  )
}
```

-----

### `renderables` - (*Array*)

##### Description

A flattened array of all component elements from `tree`. Suitable for direct access with `.find`, `.filter`, or `.map`.

<!-- TODO: example -->

-----

### `tree` - (*Object*)

##### Description

A JS object that represents the full component tree of the page to be rendered.

<!-- TODO: example -->

-----

## Prop Components

### `<props.CssLinks />` - (*Component*)

##### Description

Includes the stylesheet `<link>`s for the appropriate page/template and/or output-type. Will insert a `<link>` reference tag. In the case of page/template, the file name will be content hashed to the specific state of the page or template. For inline styles, see [`<props.Styles />`](#styles) below.

Also aliased as `<props.CssTags />`.

##### Parameters

The `CssLinks` component can be invoked on its own, or with [render props](https://reactjs.org/docs/render-props.html). If invoked on its own, it will render `<link>` tags for both the Output Type stylesheet as well as the template-specific stylesheet.

`<props.CssLinks />`

If invoked with a render prop, it will accept a function that gets passed the URLs for both the Output Type stylesheet and template-specific stylesheet passed to it, which the function can then use to render the `<link>` tags on its own.

`<props.CssLinks>{renderProp}</props.CssLinks>`
- `renderProp(stylesheetObj)` (*Function*): Function whose purpose is to render `<link>` tags, given an object containing stylesheet URLs.
  - `stylesheetObj` (*Object*): A wrapper object containing the `outputTypeHref` and `templateHref` key/value pairs.
    - `stylesheetObj.outputTypeHref` (*String*): The stylesheet URL for CSS included in the Output Type itself.
    - `stylesheetObj.templateHref` (*String*): The stylesheet URL for CSS included in the components specific to this page/template implementation.

##### Return

Renders the return value of the passed `renderProp` if one is provided; otherwise, renders `<link>` tags for the Output Type and specified template.

##### Example

*No Render Props*
```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    ...
    <props.CssLinks />
    ...
  )
}
```

*With Render Props*

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    ...
    <props.CssLinks>
      {({outputTypeHref, templateHref}) => {
        // Only rendering the outputTypeHref, not the templateHref
        return (<link rel='stylesheet' type='text/css' href={outputTypeHref} />)
      }}
    </props.CssLinks>
    ...
  )
}
```

> **NOTE**
>
> Customizing reference links is not recommended unless absolutely necessary. If inserting a custom link to the page/template styles, please be sure to include `id="fusion-template-styles"` since that ID is used to update the styles in the case of a newly-published template.

-----

### `<props.Fusion />` - (*Component*)

##### Description

Include a special script block that includes Fusion-specific values, as well as the server-fetched content cache that is used during client-side refresh to prevent content flashing.

Content refresh may be specifically disabled. This only applies to content that was previously fetched server-side and is available in the content cache; any content that is not in the cache will be fetched from the client, regardless. This feature is generally only useful in the case of prerendered HTML. On-demand HTML is already aware that its content is fresh and will not attempt client-side fetching.

##### Parameters

None

##### Return

Renders bootstrapped Fusion-specific values, as well as cached content fetched from the server side, to the DOM for Fusion's use.

##### Example

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    <html>
      <head>
        ...
      </head>
      <body>
        ...
        <props.Fusion />
      </body>
    </html>
  )
}
```

-----

### `<props.Libs />` - (*Component*)

##### Description

Include the scripts necessary to perform client-side re-render and content refresh. This includes both a shared react script and a specific page/template script.

##### Parameters

None

##### Return

Renders the React engine script and Fusion template script necessary to re-hydrate and re-render the React app client side.

##### Example

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    <html>
      <head>
        ...
        <props.Libs />
        ...
      </head>
      ...
    </html>
  )
}
```

-----

### `<props.MetaTag />` - (*Component*)

##### Description

This component will insert meta tags into your rendered HTML. If name is provided, it will insert the single meta tag specified. If no name is given, it will insert all meta tags that are enabled in the admin.

Also aliased as `<props.MetaTags />`.

##### Parameters

Parameters are passed to the MetaTag component as props.

`<props.MetaTag [name] [default] />`
- `name` (*String*): A string representing the name of the `<meta>` tag to be rendered; this should correspond to a meta option set in the PageBuilder admin.
- `default` (*String*): The default value this `<meta>` tag should contain if a value has not been set in PageBuilder.


##### Return

Renders the specified `<meta>` tag by name if one is provided; if not, renders all `<meta>` tags for this page.

##### Example

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    <html>
      <head>
        ...
        <props.MetaTag name='description' default='This is a page about cats.' />
        ...
      </head>
      ...
    </html>
  )
}
```
-----

### `<props.Styles />` - (*Component*)

##### Description

Include the generated CSS for the appropriate page/template and/or output-type. Will insert the computed inlined styles appropriate to the rendering. For a reference link, see [`<props.CssLinks />`](#props.CssLinks) below.

##### Parameters

The `Styles` component can be invoked on its own, or with [render props](https://reactjs.org/docs/render-props.html). If invoked on its own, it will render `<style>` tags including the CSS for both the Output Type stylesheet as well as the template-specific stylesheet.

`<props.Styles />`

If invoked with a render prop, it will accept a function that gets passed the URLs for both the Output Type stylesheet and template-specific stylesheet passed to it, which the function can then use to render the `<link>` tags on its own.

`<props.Styles>{renderProp}</props.Styles>`
- `renderProp(stylesObj)` (*Function*): Function whose purpose is to render `<link>` tags, given an object containing stylesheet URLs.
  - `stylesObj` (*Object*): A wrapper object containing the `outputTypeStyles` and `templateStyles` key/value pairs.
    - `stylesObj.outputTypeStyles` (*String*): The CSS for the Output Type itself.
    - `stylesObj.templateStyles` (*String*): The CSS for the components specific to this page/template implementation.

##### Return

Renders the return value of the passed `renderProp` if one is provided; otherwise, renders `<style>` tags for the Output Type and specified template containing relevant CSS.

##### Example

*No Render Prop*

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    <html>
      <head>
        ...
        <props.Styles />
        ...
      </head>
      ...
    </html>
  )
}
```

*With Render Prop*

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

export default (props) => {
  return (
    <html>
      <head>
        ...
        <props.Styles>
          {({outputTypeStyles, templateStyles}) => {
            // Only rendering the outputTypeStyles, not the templateStyles
            return (<style amp-custom='true'>{outputTypeStyles}</style>)
          }}
        </props.Styles>
        ...
      </head>
      ...
    </html>
  )
}
```

-----

## Static Values

### `displayPropTypes`

##### Description
 Implements  React's [PropTypes](https://github.com/facebook/prop-types) which will be available on each feature. These are defined the same way as `propTypes` on Features and Chains however, unlike custom fields, the values can differ across Output Types. `displayProperties` are useful for high level page functionality such as hide/show logic, layout grids, or any other settings that you want each feature to have.

The value [`props.displayProperties`](./feature.md#displayProperties) will be available on Features, and contain the key names defined here and the values set in PageBuilder.

##### Example
On the Output Type

```jsx
/*  /src/components/output-types/default.jsx  */

import React from 'react'

const DefaultOutputType = (props) => {
  ...
}

DefaultOutputType.displayPropTypes = {
  isStatic: PropTypes.bool,
  width: PropTypes.number,
  anchor: PropTypes.string
}

export default DefaultOutputType
```
