name: fusion-origin
type: ecs

_admin_environment: &_admin_environment
  IS_ADMIN: 'true'
  PB_ADMIN: 'http://$environment.pb.aws.arc.pub'

_fusion_origin: &_fusion_origin
  image: quay.io/washpost/fusion-origin:{{.DeploymentId}}
  ports:
    - '8080'
  log_driver: awslogs

_healthcheck: &_healthcheck
  healthcheck:
    interval: 30
    path: '/healthcheck'
    protocol: HTTP
    timeout: 10
    healthy_threshold_count: 2
    unhealthy_threshold_count: 4

_resource: &_resource
  vendor: aws
  resource: simple

_deploymentConfiguration: &_deploymentConfiguration
  maximumPercent: 200
  minimumHealthyPercent: 50

_loadBalancer: &_loadBalancer
  containerName: origin
  containerPort: 8080

_service: &_service
  deploymentConfiguration: *_deploymentConfiguration
  desiredCount: 2
  loadBalancers:
    - *_loadBalancer

_services: &_services
  - *_service

_arc_task: &_arc_task
  taskRoleArn: arn:aws:iam::397853141546:role/fusion-origin

_pb_task: &_pb_task
  taskRoleArn: arn:aws:iam::057404813832:role/fusion-origin

environments:
#
# staging
#
  - name: staging
    services:  *_services
    task: *_arc_task
    labels:
      - all
      - staging
    namespace: pagebuilder-arc2
    override:
      origin:
        <<: *_fusion_origin
        log_opt:
          awslogs-group: /nile/fusion-origin/staging
          awslogs-region: us-east-1
        environment:
          CONTEXT_PATH: pf
          AWS_ACCOUNT_ID: '397853141546'
          S3_BUCKET: pagebuilder-fusion
        # volumes:
        # - '/var/fusion-origin/staging/uploads:/uploads'
    resources:
      - <<: *_resource
        settings:
          <<: *_healthcheck
          scheme: internet-facing
          domain: staging.fusion.arcpublishing.com
          parent_domain: fusion.arcpublishing.com
          subnets:
            - subnet-1a8f9640
            - subnet-9d4bafb2
            - subnet-42943209

  - name: staging-admin
    services: *_services
    task: *_arc_task
    labels:
      - all
      - staging
    namespace: pagebuilder-arc2
    override:
      origin:
        <<: *_fusion_origin
        log_opt:
          awslogs-group: /nile/fusion-origin/staging
          awslogs-region: us-east-1
        environment:
          <<: *_admin_environment
          CONTEXT_PATH: pb
          PB_ADMIN: 'http://$environment.pb.arc.pub'
          AWS_ACCOUNT_ID: '397853141546'
          S3_BUCKET: pagebuilder-fusion
        # volumes:
        # - '/var/fusion-origin/staging/uploads:/uploads'
    resources:
      - <<: *_resource
        settings:
          <<: *_healthcheck
          scheme: internal
          domain: staging.fusion.arc.pub
          parent_domain: fusion.arc.pub
          subnets:
            - subnet-1a8f9640
            - subnet-9d4bafb2
            - subnet-42943209

#
# arc
#
  - name: arc
    services:  *_services
    task: *_arc_task
    labels:
      - all
      - arc
    namespace: pagebuilder-arc2
    override:
      origin:
        <<: *_fusion_origin
        log_opt:
          awslogs-group: /nile/fusion-origin/arc
          awslogs-region: us-east-1
        environment:
          CONTEXT_PATH: pb
          AWS_ACCOUNT_ID: '397853141546'
          S3_BUCKET: pagebuilder-fusion
        # volumes:
        # - '/var/fusion-origin/staging/uploads:/uploads'
    resources:
      - <<: *_resource
        settings:
          <<: *_healthcheck
          scheme: internet-facing
          domain: arc.fusion.arcpublishing.com
          parent_domain: fusion.arcpublishing.com
          subnets:
            - subnet-1a8f9640
            - subnet-9d4bafb2
            - subnet-42943209

  - name: arc-admin
    services: *_services
    task: *_arc_task
    labels:
      - all
      - arc
    namespace: pagebuilder-arc2
    override:
      origin:
        <<: *_fusion_origin
        log_opt:
          awslogs-group: /nile/fusion-origin/arc
          awslogs-region: us-east-1
        environment:
          <<: *_admin_environment
          CONTEXT_PATH: pb
          PB_ADMIN: 'http://$environment.pb.arc.pub'
          AWS_ACCOUNT_ID: '397853141546'
          S3_BUCKET: pagebuilder-fusion
        # volumes:
        # - '/var/fusion-origin/staging/uploads:/uploads'
    resources:
      - <<: *_resource
        settings:
          <<: *_healthcheck
          scheme: internal
          domain: arc.fusion.arc.pub
          parent_domain: fusion.arc.pub
          subnets:
            - subnet-1a8f9640
            - subnet-9d4bafb2
            - subnet-42943209

#
# eu-central-1
#
  - name: eu-central-1
    task: *_pb_task
    labels:
      - all
      - eu-central-1
    namespace: fusion-ecs-eu-central-1
    override:
      origin:
        <<: *_fusion_origin
        log_opt:
          awslogs-group: /nile/fusion-origin
          awslogs-region: eu-central-1
        environment:
          CONTEXT_PATH: pb
    services:
      - <<: *_service
        loadBalancers:
          - <<: *_loadBalancer
            targetGroupArn: arn:aws:elasticloadbalancing:eu-central-1:057404813832:targetgroup/fusion-origin-eu-central-1/9a927c3c38fdbe35

  - name: eu-central-1-admin
    task: *_pb_task
    labels:
      - all
      - eu-central-1
    namespace: fusion-ecs-eu-central-1
    services:
    - <<: *_service
      loadBalancers:
        - <<: *_loadBalancer
          targetGroupArn: arn:aws:elasticloadbalancing:eu-central-1:057404813832:targetgroup/fusion-admin-origin-eu-central-1/b5dd40230aeff095
    override:
      origin:
        <<: *_fusion_origin
        log_opt:
          awslogs-group: /nile/fusion-origin
          awslogs-region: eu-central-1
        environment:
          <<: *_admin_environment
          CONTEXT_PATH: pb

#
# us-east-1
#
  - name: us-east-1
    task: *_pb_task
    labels:
      - all
      - us-east-1
    namespace: fusion-ecs-us-east-1
    override:
      origin:
        <<: *_fusion_origin
        log_opt:
          awslogs-group: /nile/fusion-origin
          awslogs-region: us-east-1
    services:
      - <<: *_service
        loadBalancers:
          - <<: *_loadBalancer
            targetGroupArn: arn:aws:elasticloadbalancing:us-east-1:057404813832:targetgroup/fusion-origin-us-east-1/d69f7df3d462cf7e

  - name: us-east-1-admin
    task: *_pb_task
    labels:
      - all
      - us-east-1
    namespace: fusion-ecs-us-east-1
    services:
    - <<: *_service
      loadBalancers:
        - <<: *_loadBalancer
          targetGroupArn: arn:aws:elasticloadbalancing:us-east-1:057404813832:targetgroup/fusion-admin-origin-us-east-1/8c5b695865949311
    override:
      origin:
        <<: *_fusion_origin
        log_opt:
          awslogs-group: /nile/fusion-origin
          awslogs-region: us-east-1
        environment:
          <<: *_admin_environment
